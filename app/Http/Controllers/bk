<?php

namespace App\Http\Controllers;

use Abraham\TwitterOAuth\TwitterOAuth;
use Mmerian\Phpcrawl\Libs\PHPCrawler;
use Illuminate\Http\Request;
use App\Http\Requests;
use App\Http\Controllers\Controller;


class gtrendscrawler extends Controller
{
  function handleDocumentInfo($DocInfo)
  {
    // Just detect linebreak for output ("\n" in CLI-mode, otherwise "<br>").
    if (PHP_SAPI == "cli") $lb = "\n";
    else $lb = "<br />";

    // Print if the content of the document was be recieved or not
    if ($DocInfo->received == true)
    {$regex = '#\<div id="reportMain"\>(.+?)\<\/div\>#s';
    preg_match($regex, $DocInfo, $matches);
    $match = $matches[0];
    echo $match;}
    else
      echo "Content not received".$lb;

    // Now you should do something with the content of the actual
    // received page or file ($DocInfo->source), we skip it in this example

    echo $lb;

    flush();
  }
}

class searchController extends Controller
{
    public function twittersearch($query)
    {
      $consumer="3Hsr7qk9HEYseF9bpJA07Go6H";
      $consumersecret="q1TjkWCHcPKrJn0YCmtKMwIHaXURI7ip3z5eDxDd4G0GxLsUOi";
      $accesstoken = "3803581341-FAlmx3CbE2amgcMyD2AkGYuLdRa7kZ3QcDSxj5a";
      $accesstokensecret = "1JtROKIjMaIhP6IJGMPGbTyRTF9WMyq1RGclpdvcKzZWD";
      $twitter= new TwitterOAuth($consumer,$consumersecret,$accesstoken,$accesstokensecret);
      $url="search/tweets";
      $tweets = $twitter->get($url, array('q'=>$query,'result_type'=>'recent'));
      return $tweets;
    }

    public function gtrendsdisplay($query)
    {
      $crawler = new gtrendscrawler();

      // URL to crawl
      $crawler->setURL("https://www.google.com/trends/explore#q=haytham");
      $crawler->setCrawlingDepthLimit('0');

      // Only receive content of files with content-type "text/html"
      $crawler->addContentTypeReceiveRule("#text/html#");

      // Store and send cookie-data like a browser does
      $crawler->enableCookieHandling(true);

      // Thats enough, now here we go
      $crawler->go();

    }
    //Google Trends
    public function display(Request $request)
    {
      $keyword = $request->input('keyword');
      $tweets=$this->twittersearch($keyword);
      $trends=$this->gtrendsdisplay('haytham');
      $data=array('keyword'=>$keyword,'tweets'=>$tweets,'trends'=>$trends);
      return view('results',$data);
    }


}
